<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åˆ†å‰²æ‰•ã„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f14;
    --surface: #16161e;
    --surface2: #1e1e2a;
    --surface3: #252535;
    --border: #2e2e42;
    --accent: #7b6fff;
    --accent2: #ff6b9d;
    --accent3: #00e5c8;
    --text: #e8e8f0;
    --text-muted: #7070a0;
    --text-dim: #4a4a6a;
    --green: #52e0a0;
    --yellow: #ffd166;
    --red: #ff6b6b;
    --radius: 12px;
    --radius-sm: 8px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans JP', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse 80% 60% at 20% 0%, rgba(123,111,255,0.08) 0%, transparent 60%),
      radial-gradient(ellipse 60% 50% at 80% 100%, rgba(0,229,200,0.06) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 24px;
    position: relative;
    z-index: 1;
  }

  /* Header */
  header {
    margin-bottom: 48px;
    animation: fadeDown 0.6s ease both;
  }

  .header-tag {
    display: inline-block;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.15em;
    color: var(--accent3);
    background: rgba(0,229,200,0.08);
    border: 1px solid rgba(0,229,200,0.2);
    padding: 4px 12px;
    border-radius: 100px;
    margin-bottom: 16px;
  }

  h1 {
    font-size: clamp(24px, 4vw, 38px);
    font-weight: 700;
    letter-spacing: -0.02em;
    line-height: 1.2;
    background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header-sub {
    margin-top: 10px;
    font-size: 14px;
    color: var(--text-muted);
    font-weight: 400;
  }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    margin-bottom: 24px;
    animation: fadeUp 0.5s ease both;
  }

  .card-title {
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title::before {
    content: '';
    width: 4px;
    height: 14px;
    background: var(--accent);
    border-radius: 2px;
    display: inline-block;
  }

  /* Grid */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 700px) { .grid-2 { grid-template-columns: 1fr; } }

  /* Labels & Inputs */
  label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
    margin-bottom: 8px;
    letter-spacing: 0.05em;
  }

  input[type="file"] {
    display: none;
  }

  .file-drop {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 32px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--surface2);
    position: relative;
  }

  .file-drop:hover, .file-drop.dragover {
    border-color: var(--accent);
    background: rgba(123,111,255,0.06);
  }

  .file-drop-icon {
    font-size: 28px;
    margin-bottom: 10px;
  }

  .file-drop-text {
    font-size: 14px;
    color: var(--text-muted);
  }

  .file-drop-text strong {
    color: var(--accent);
    font-weight: 500;
  }

  .file-name {
    margin-top: 10px;
    font-size: 13px;
    font-family: 'DM Mono', monospace;
    color: var(--accent3);
    display: none;
  }

  /* Mode Tabs */
  .mode-tabs {
    display: flex;
    gap: 4px;
    background: var(--surface2);
    padding: 4px;
    border-radius: var(--radius-sm);
    margin-bottom: 20px;
  }

  .mode-tab {
    flex: 1;
    padding: 10px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-size: 13px;
    font-family: 'Noto Sans JP', sans-serif;
    font-weight: 500;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
    letter-spacing: 0.02em;
  }

  .mode-tab.active {
    background: var(--surface3);
    color: var(--text);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  /* Select / Input styled */
  select, input[type="text"], input[type="number"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 14px;
    padding: 10px 14px;
    outline: none;
    transition: border-color 0.2s;
    appearance: none;
    -webkit-appearance: none;
  }

  select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%237070a0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px;
  }

  select:focus, input[type="text"]:focus, input[type="number"]:focus {
    border-color: var(--accent);
  }

  /* Checkbox grid for installments */
  .checkbox-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 4px;
  }

  .checkbox-item {
    position: relative;
  }

  .checkbox-item input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .checkbox-item label {
    display: inline-block;
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 100px;
    cursor: pointer;
    font-size: 13px;
    font-family: 'DM Mono', monospace;
    color: var(--text-muted);
    transition: all 0.15s;
    margin: 0;
    user-select: none;
    letter-spacing: 0.05em;
  }

  .checkbox-item input[type="checkbox"]:checked + label {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
    font-weight: 500;
  }

  .checkbox-item label:hover {
    border-color: var(--accent);
    color: var(--text);
  }

  /* Button */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 28px;
    border: none;
    border-radius: var(--radius-sm);
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
    box-shadow: 0 4px 20px rgba(123,111,255,0.3);
  }

  .btn-primary:hover {
    background: #9088ff;
    transform: translateY(-1px);
    box-shadow: 0 6px 24px rgba(123,111,255,0.4);
  }

  .btn-primary:active { transform: translateY(0); }

  .btn-secondary {
    background: var(--surface3);
    color: var(--text-muted);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    color: var(--text);
    border-color: var(--text-muted);
  }

  .btn-row {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    flex-wrap: wrap;
  }

  /* Product preview */
  .product-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 4px;
  }

  .product-chip {
    background: var(--surface3);
    border: 1px solid var(--border);
    border-radius: 100px;
    padding: 4px 14px;
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .product-chip .price {
    color: var(--accent);
    font-weight: 500;
  }

  /* Results section */
  .results-section {
    animation: fadeUp 0.4s ease both;
  }

  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .results-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
  }

  /* Product result block */
  .product-result {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 20px;
    overflow: hidden;
    animation: fadeUp 0.4s ease both;
  }

  .product-result-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 24px;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
  }

  .product-result-name {
    font-size: 15px;
    font-weight: 700;
    color: var(--text);
  }

  .product-result-price {
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    color: var(--accent3);
    font-weight: 500;
  }

  /* Table */
  .table-wrap {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead th {
    padding: 12px 16px;
    text-align: right;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  thead th:first-child {
    text-align: left;
  }

  tbody td {
    padding: 13px 16px;
    text-align: right;
    border-bottom: 1px solid rgba(46,46,66,0.5);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    color: var(--text-muted);
    white-space: nowrap;
  }

  tbody td:first-child {
    text-align: left;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
  }

  tbody tr:last-child td { border-bottom: none; }

  tbody tr:hover td { background: rgba(123,111,255,0.04); }

  tbody tr.lump td:first-child {
    color: var(--accent3);
  }

  .monthly-pay {
    color: var(--green) !important;
    font-weight: 500;
  }

  .total-pay {
    color: var(--yellow) !important;
    font-weight: 500;
  }

  .fee-pay {
    color: var(--text-muted) !important;
  }

  .zero-fee { color: var(--text-dim) !important; }

  /* Divider */
  .divider {
    height: 1px;
    background: var(--border);
    margin: 32px 0;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 24px;
    color: var(--text-dim);
    font-size: 14px;
  }

  .empty-state-icon { font-size: 36px; margin-bottom: 12px; }

  /* Alert */
  .alert {
    background: rgba(255,107,107,0.08);
    border: 1px solid rgba(255,107,107,0.2);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    font-size: 13px;
    color: var(--red);
    margin-bottom: 16px;
    display: none;
  }

  /* Animations */
  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-16px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* Summary Table */
  .summary-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 28px;
    overflow: hidden;
    animation: fadeUp 0.4s ease both;
  }

  .summary-block-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 16px 24px;
    background: linear-gradient(90deg, rgba(123,111,255,0.12) 0%, rgba(0,229,200,0.06) 100%);
    border-bottom: 1px solid var(--border);
  }

  .summary-block-title {
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--accent3);
  }

  .summary-block-sub {
    font-size: 11px;
    color: var(--text-dim);
    margin-left: auto;
  }

  .summary-table th:first-child {
    text-align: left;
    min-width: 90px;
  }

  .summary-table td.s-lump {
    color: var(--accent3) !important;
    font-weight: 500;
  }

  .summary-table td.s-monthly {
    color: var(--green) !important;
    font-weight: 500;
  }

  /* Utility */
  .hidden { display: none !important; }
  .mt-8 { margin-top: 8px; }
  .mt-16 { margin-top: 16px; }

  /* Section label */
  .section-label {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 10px;
  }

  .mode-panel { display: none; }
  .mode-panel.active { display: block; }

  .card-note {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 12px;
    line-height: 1.6;
  }

  /* credit card chips */
  .card-chip-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 6px;
  }

  .card-chip {
    background: var(--surface3);
    border: 1px solid var(--border);
    border-radius: 100px;
    padding: 5px 14px;
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
  }

  .card-chip.selected {
    background: rgba(123,111,255,0.15);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* min badge */
  .min-badge {
    display: inline-block;
    font-size: 9px;
    font-family: 'DM Mono', monospace;
    background: rgba(82,224,160,0.15);
    color: var(--green);
    border: 1px solid rgba(82,224,160,0.3);
    border-radius: 100px;
    padding: 1px 6px;
    margin-left: 4px;
    vertical-align: middle;
    letter-spacing: 0.05em;
  }
</style>
</head>
<body>

<div class="container">

  <!-- Header -->
  <header>
    <div class="header-tag">PAYMENT CALCULATOR</div>
    <h1>åˆ†å‰²æ‰•ã„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <p class="header-sub">CSVã‚’èª­ã¿è¾¼ã‚“ã§ã€è¤‡æ•°å•†å“ã®åˆ†å‰²æ‰•ã„æ–™é‡‘ã‚’ä¸€æ‹¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</p>
  </header>

  <!-- STEP 1: CSVèª­ã¿è¾¼ã¿ -->
  <div class="card" style="animation-delay:0.05s">
    <div class="card-title">STEP 1 â€” CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€</div>

    <div class="file-drop" id="fileDrop" onclick="document.getElementById('csvInput').click()">
      <div class="file-drop-icon">ğŸ“‚</div>
      <div class="file-drop-text"><strong>ã‚¯ãƒªãƒƒã‚¯</strong>ã—ã¦CSVã‚’é¸æŠã€ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
      <div class="file-drop-text" style="font-size:12px; margin-top:4px; color:var(--text-dim)">å½¢å¼ï¼šå•†å“å, ä¾¡æ ¼ï¼ˆ1è¡Œç›®ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰</div>
      <div class="file-name" id="fileName"></div>
    </div>
    <input type="file" id="csvInput" accept=".csv">

    <div id="productPreview" class="mt-16 hidden">
      <div class="section-label">èª­ã¿è¾¼ã‚“ã å•†å“</div>
      <div class="product-list" id="productList"></div>
    </div>

    <div class="alert" id="csvAlert"></div>
  </div>

  <!-- STEP 2: è¨ˆç®—è¨­å®š -->
  <div class="card" style="animation-delay:0.1s">
    <div class="card-title">STEP 2 â€” è¨ˆç®—æ–¹å¼ãƒ»æ¡ä»¶ã‚’è¨­å®šã™ã‚‹</div>

    <!-- Mode tabs -->
    <div class="mode-tabs">
      <button class="mode-tab active" onclick="switchMode('annual')" id="tabAnnual">å®Ÿè³ªå¹´ç‡ãƒ¢ãƒ¼ãƒ‰</button>
      <button class="mode-tab" onclick="switchMode('card')" id="tabCard">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰</button>
    </div>

    <!-- Annual Rate Mode -->
    <div class="mode-panel active" id="panelAnnual">
      <div class="grid-2">
        <div>
          <label>å®Ÿè³ªå¹´ç‡ (ï¼…)</label>
          <select id="annualRate">
            <option value="2.0">2.0%</option>
            <option value="2.5">2.5%</option>
            <option value="3.0">3.0%</option>
            <option value="3.5">3.5%</option>
            <option value="4.0">4.0%</option>
            <option value="4.5">4.5%</option>
            <option value="5.0">5.0%</option>
            <option value="5.5">5.5%</option>
            <option value="6.0">6.0%</option>
            <option value="6.5">6.5%</option>
            <option value="7.0">7.0%</option>
            <option value="7.5">7.5%</option>
            <option value="8.0">8.0%</option>
            <option value="8.5">8.5%</option>
            <option value="9.0">9.0%</option>
            <option value="9.5">9.5%</option>
            <option value="10.0">10.0%</option>
            <option value="10.5">10.5%</option>
            <option value="11.0">11.0%</option>
            <option value="11.5">11.5%</option>
            <option value="12.0">12.0%</option>
            <option value="12.5">12.5%</option>
            <option value="13.0">13.0%</option>
            <option value="13.5">13.5%</option>
            <option value="14.0">14.0%</option>
            <option value="14.5">14.5%</option>
            <option value="15.0">15.0%</option>
            <option value="15.5">15.5%</option>
            <option value="16.0">16.0%</option>
            <option value="16.5">16.5%</option>
            <option value="17.0">17.0%</option>
            <option value="17.5">17.5%</option>
            <option value="18.0" selected>18.0%</option>
            <option value="18.5">18.5%</option>
            <option value="19.0">19.0%</option>
            <option value="19.5">19.5%</option>
            <option value="19.8">19.8%</option>
            <option value="20.0">20.0%</option>
            <option value="20.5">20.5%</option>
            <option value="21.0">21.0%</option>
            <option value="21.5">21.5%</option>
            <option value="22.0">22.0%</option>
            <option value="22.5">22.5%</option>
            <option value="23.0">23.0%</option>
            <option value="23.5">23.5%</option>
            <option value="24.0">24.0%</option>
            <option value="24.5">24.5%</option>
            <option value="25.0">25.0%</option>
            <option value="25.5">25.5%</option>
            <option value="26.0">26.0%</option>
            <option value="26.5">26.5%</option>
            <option value="27.0">27.0%</option>
            <option value="27.5">27.5%</option>
            <option value="28.0">28.0%</option>
            <option value="28.5">28.5%</option>
            <option value="29.0">29.0%</option>
            <option value="29.5">29.5%</option>
            <option value="30.0">30.0%</option>
          </select>
        </div>
        <div>
          <!-- spacer or future option -->
        </div>
      </div>
      <p class="card-note">â€» æ¶ˆè²»è€…é‡‘èãƒ»ãƒ­ãƒ¼ãƒ³ç³»ã®å¹´ç‡æŒ‡å®šãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚æ—¥æœ¬ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå”ä¼šã®æ‰‹æ•°æ–™è¨ˆç®—å¼ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
    </div>

    <!-- Credit Card Mode -->
    <div class="mode-panel" id="panelCard">
      <div>
        <label>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ä¼šç¤¾ã‚’é¸æŠ</label>
        <div class="card-chip-row" id="cardChips">
          <div class="card-chip selected" data-card="0" onclick="selectCard(this)">æ”¯æ‰•å›æ•°æ¯ã®æœ€å®‰å€¤</div>
          <div class="card-chip" data-card="1" onclick="selectCard(this)">æ¥½å¤©ã‚«ãƒ¼ãƒ‰</div>
          <div class="card-chip" data-card="2" onclick="selectCard(this)">ã‚»ã‚¾ãƒ³ã‚«ãƒ¼ãƒ‰</div>
          <div class="card-chip" data-card="3" onclick="selectCard(this)">ã‚»ãƒ‡ã‚£ãƒŠã‚«ãƒ¼ãƒ‰ (SMBC)</div>
        </div>
      </div>
      <p class="card-note mt-8">â€» ã€Œæ”¯æ‰•å›æ•°æ¯ã®æœ€å®‰å€¤ã€ã¯ç™»éŒ²ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ä¼šç¤¾ã®ä¸­ã§æœ€ã‚‚ãŠå¾—ãªã‚«ãƒ¼ãƒ‰ã‚’å›æ•°ã”ã¨ã«è¡¨ç¤ºã—ã¾ã™ã€‚</p>
    </div>

    <div class="divider" style="margin: 24px 0 20px;"></div>

    <!-- Installment count selector -->
    <div>
      <label>è¡¨ç¤ºã™ã‚‹æ”¯æ‰•ã„å›æ•°ã‚’é¸æŠ</label>
      <div class="checkbox-grid" id="installmentChecks">
        <!-- JS ã§ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- STEP 3: è¨ˆç®—å®Ÿè¡Œ -->
  <div class="btn-row" style="margin-top:0; margin-bottom:32px; animation: fadeUp 0.5s 0.15s ease both; opacity:0; animation-fill-mode:both;">
    <button class="btn btn-primary" onclick="simulate()">
      <span>â–¶</span> ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    </button>
    <button class="btn btn-secondary" onclick="resetAll()">
      ãƒªã‚»ãƒƒãƒˆ
    </button>
  </div>

  <!-- Results -->
  <div id="resultsWrap" class="hidden">
    <div class="results-section">
      <div class="results-header">
        <div class="results-title" id="resultsTitle">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</div>
      </div>
      <div id="resultsContent"></div>
    </div>
  </div>

</div><!-- /container -->

<script>
// ===== ãƒ‡ãƒ¼ã‚¿å®šç¾© =====
const CARD_DATA = [
  {
    id: 1, name: "æ¥½å¤©ã‚«ãƒ¼ãƒ‰",
    number_of_payments: [3,5,6,10,12,15,18,20,24,30,36],
    annual_rate: [12.25,13.50,13.75,14.50,14.75,15.00,15.00,15.00,15.00,15.00,15.00],
    link: "https://www.rakuten-card.co.jp/adjustment/installment/"
  },
  {
    id: 2, name: "ã‚»ã‚¾ãƒ³ã‚«ãƒ¼ãƒ‰",
    number_of_payments: [3,5,6,10,12,15,18,20,24],
    annual_rate: [9.0,10.0,10.3,10.8,10.9,11.1,11.1,11.2,11.2],
    link: "https://www.saisoncard.co.jp/news/contents/nc101101_a.html"
  },
  {
    id: 3, name: "ã‚»ãƒ‡ã‚£ãƒŠã‚«ãƒ¼ãƒ‰(SMBC)",
    number_of_payments: [3,5,6,10,12,15,18,20,24,30,36],
    annual_rate: [12.20,13.51,13.86,14.57,14.73,14.87,14.93,14.95,14.96,14.91,14.82],
    link: "https://www.cedyna.co.jp/om/payment/card-shopping/installments/"
  }
];

const ALL_INSTALLMENTS = [1, 3, 5, 6, 10, 12, 15, 18, 20, 24, 36, 48, 60];
let currentMode = 'annual';
let selectedCardId = 0;
let products = [];

// ===== åˆæœŸåŒ– =====
function init() {
  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ
  const grid = document.getElementById('installmentChecks');
  ALL_INSTALLMENTS.forEach(n => {
    const item = document.createElement('div');
    item.className = 'checkbox-item';
    const label = n === 1 ? 'ä¸€æ‹¬' : `${n}å›`;
    const defaultChecked = [1,3,6,12,24].includes(n);
    item.innerHTML = `
      <input type="checkbox" id="inst_${n}" value="${n}" ${defaultChecked ? 'checked' : ''}>
      <label for="inst_${n}">${label}</label>
    `;
    grid.appendChild(item);
  });

  // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—
  const drop = document.getElementById('fileDrop');
  const input = document.getElementById('csvInput');

  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
  drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
  drop.addEventListener('drop', e => {
    e.preventDefault();
    drop.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) loadCSV(file);
  });

  input.addEventListener('change', e => {
    if (e.target.files[0]) loadCSV(e.target.files[0]);
  });
}

// ===== CSVèª­ã¿è¾¼ã¿ =====
function loadCSV(file) {
  if (!file.name.endsWith('.csv')) { showAlert('csvAlert', 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  hideAlert('csvAlert');
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    parseCSV(text);
    document.getElementById('fileName').style.display = 'block';
    document.getElementById('fileName').textContent = 'âœ“ ' + file.name;
  };
  reader.readAsText(file, 'UTF-8');
}

function parseCSV(text) {
  const lines = text.trim().split('\n').map(l => l.trim()).filter(l => l);
  if (lines.length < 2) { showAlert('csvAlert', 'ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ + ãƒ‡ãƒ¼ã‚¿è¡ŒãŒå¿…è¦ã§ã™ï¼‰'); return; }

  products = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',').map(c => c.trim().replace(/[Â¥,ï¿¥"]/g, ''));
    if (cols.length < 2) continue;
    const name = cols[0];
    const price = parseInt(cols[1].replace(/[^0-9]/g, ''));
    if (name && !isNaN(price) && price > 0) {
      products.push({ name, price });
    }
  }

  if (products.length === 0) { showAlert('csvAlert', 'æœ‰åŠ¹ãªå•†å“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); return; }

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
  const list = document.getElementById('productList');
  list.innerHTML = '';
  products.forEach(p => {
    const chip = document.createElement('div');
    chip.className = 'product-chip';
    chip.innerHTML = `${p.name} <span class="price">${commaFormat(p.price)}</span>`;
    list.appendChild(chip);
  });

  document.getElementById('productPreview').classList.remove('hidden');
  showAlert('csvAlert', '', false);
}

// ===== ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ =====
function switchMode(mode) {
  currentMode = mode;
  document.getElementById('panelAnnual').classList.toggle('active', mode === 'annual');
  document.getElementById('panelCard').classList.toggle('active', mode === 'card');
  document.getElementById('tabAnnual').classList.toggle('active', mode === 'annual');
  document.getElementById('tabCard').classList.toggle('active', mode === 'card');
}

// ===== ã‚«ãƒ¼ãƒ‰é¸æŠ =====
function selectCard(el) {
  document.querySelectorAll('#cardChips .card-chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  selectedCardId = parseInt(el.dataset.card);
}

// ===== è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ =====
function calAddonRate(yearRate, paymentsNum) {
  const r = parseFloat(yearRate) / 100;
  let feeRate = (paymentsNum * r / 12) / (1 - Math.pow(1 + r / 12, -paymentsNum)) - 1;
  feeRate = feeRate * 100;
  return parseFloat(feeRate.toFixed(2));
}

function calcAnnualMode(price, yearRate, paymentsNum) {
  if (paymentsNum === 1) {
    return { paymentsNum: 'ä¸€æ‹¬', firstPay: price, secondsPay: 0, fee: 0, feeRate: 0, payment: price };
  }
  const feeRate = calAddonRate(yearRate, paymentsNum);
  const fee = Math.ceil(price * feeRate) / 100;
  const payment = parseInt(price) + parseInt(fee);
  const monthlyPay = Math.floor(parseInt(payment) / parseInt(paymentsNum));
  const secondsPay = Math.floor(monthlyPay * 0.01) * 100;
  const firstPay = payment - (secondsPay * (paymentsNum - 1));
  return {
    paymentsNum,
    firstPay,
    secondsPay,
    fee: parseInt(fee),
    feeRate,
    payment
  };
}

function calcCardMain(price, number, pay) {
  if (number == 1) {
    return { number: 'ä¸€æ‹¬', split_fee: 0, split_fee_cost: price, split_fee_cost_per_month: price };
  }
  const src = parseInt(price);
  const split_fee = parseInt(Math.ceil(src * pay) / 100);
  const split_fee_cost = split_fee + src;
  const split_fee_cost_per_month = parseInt(split_fee_cost / number);
  return { number: parseInt(number), split_fee, split_fee_cost, split_fee_cost_per_month };
}

// ===== ãƒ¡ã‚¤ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ =====
// ===== ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ =====
function buildSummaryTable(content, selectedInsts, getMonthly) {
  // getMonthly(product, n) => { value: number|null, label?: string }
  const block = document.createElement('div');
  block.className = 'summary-block';

  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆå•†å“åï¼‰
  let thCells = '<th>æ”¯æ‰•ã„å›æ•°</th>';
  products.forEach(p => {
    thCells += `<th>${p.name}<br><span style="font-weight:400;color:var(--text-dim);font-size:11px">${commaFormat(p.price)}</span></th>`;
  });

  // ãƒ‡ãƒ¼ã‚¿è¡Œ
  let rows = '';
  selectedInsts.forEach(n => {
    const isLump = n === 1;
    let row = `<tr>`;
    row += `<td style="text-align:left;font-family:'Noto Sans JP';font-size:13px;font-weight:500;color:${isLump ? 'var(--accent3)' : 'var(--text)'}">
      ${isLump ? 'ä¸€æ‹¬æ‰•ã„' : n + 'å›æ‰•ã„'}
    </td>`;
    products.forEach(p => {
      const result = getMonthly(p, n);
      if (result === null) {
        row += `<td style="color:var(--text-dim);font-size:11px;text-align:center">â€”</td>`;
      } else {
        row += `<td class="${isLump ? 's-lump' : 's-monthly'}">${commaFormat(result)}</td>`;
      }
    });
    row += '</tr>';
    rows += row;
  });

  block.innerHTML = `
    <div class="summary-block-header">
      <span class="summary-block-title">ğŸ“Š æœˆã€…ã®æ”¯æ‰•é¡ æ¯”è¼ƒè¡¨</span>
      <span class="summary-block-sub">å•†å“ã”ã¨ã®æœˆã€…æ”¯æ‰•é¡ã‚’æ¨ªä¸¦ã³ã§ç¢ºèª</span>
    </div>
    <div class="table-wrap">
      <table class="summary-table">
        <thead><tr>${thCells}</tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;

  content.appendChild(block);
}

function simulate() {
  if (products.length === 0) {
    showAlert('csvAlert', 'ã¾ãšCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
    return;
  }

  const selectedInsts = Array.from(document.querySelectorAll('#installmentChecks input[type="checkbox"]:checked'))
    .map(c => parseInt(c.value)).sort((a, b) => a - b);

  if (selectedInsts.length === 0) {
    alert('æ”¯æ‰•ã„å›æ•°ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
    return;
  }

  const wrap = document.getElementById('resultsWrap');
  const content = document.getElementById('resultsContent');
  content.innerHTML = '';
  wrap.classList.remove('hidden');

  if (currentMode === 'annual') {
    const yearRate = parseFloat(document.getElementById('annualRate').value);
    document.getElementById('resultsTitle').textContent = `ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ â€” å®Ÿè³ªå¹´ç‡ ${yearRate}%`;

    // ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå®Ÿè³ªå¹´ç‡ãƒ¢ãƒ¼ãƒ‰ï¼‰
    buildSummaryTable(content, selectedInsts, (p, n) => {
      const d = calcAnnualMode(p.price, yearRate, n);
      if (n === 1) return d.firstPay;
      return d.secondsPay;
    });

    products.forEach((p, idx) => {
      const block = document.createElement('div');
      block.className = 'product-result';
      block.style.animationDelay = (idx * 0.08) + 's';

      let rows = '';
      selectedInsts.forEach(n => {
        const d = calcAnnualMode(p.price, yearRate, n);
        const isLump = n === 1;
        rows += `<tr class="${isLump ? 'lump' : ''}">
          <td>${isLump ? 'ä¸€æ‹¬æ‰•ã„' : d.paymentsNum + 'å›æ‰•ã„'}</td>
          <td class="monthly-pay">${commaFormat(d.firstPay)}</td>
          <td class="monthly-pay">${isLump ? '<span class="zero-fee">â€”</span>' : commaFormat(d.secondsPay)}</td>
          <td class="fee-pay">${isLump ? '<span class="zero-fee">Â¥0</span>' : commaFormat(d.fee)}</td>
          <td class="total-pay">${commaFormat(d.payment)}</td>
        </tr>`;
      });

      block.innerHTML = `
        <div class="product-result-header">
          <span class="product-result-name">${p.name}</span>
          <span class="product-result-price">${commaFormat(p.price)}</span>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>æ”¯æ‰•ã„å›æ•°</th>
                <th>1å›ç›®æ”¯æ‰•ã„é¡</th>
                <th>2å›ç›®ä»¥é™æ”¯æ‰•é¡</th>
                <th>æ‰‹æ•°æ–™</th>
                <th>æ”¯æ‰•ç·é¡</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
      content.appendChild(block);
    });

    // æ³¨é‡ˆã‚’è¿½åŠ 
    const note = document.createElement('p');
    note.style.cssText = 'font-size:12px;color:var(--text-dim);margin-top:16px;line-height:1.8;';
    note.innerHTML = 'â€»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆè¨ˆç®—ã¯<a href="https://www.j-credit.or.jp/customer/basis/commission.html" target="_blank" style="color:var(--accent);text-decoration:none;">æ—¥æœ¬ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå”ä¼š</a>ã®æ‰‹æ•°æ–™è¨ˆç®—ã‚’å‚è€ƒã«ä½œæˆã—ã¦ã„ã¾ã™';
    content.appendChild(note);

  } else {
    // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰
    if (selectedCardId === 0) {
      // ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæœ€å®‰å€¤ãƒ¢ãƒ¼ãƒ‰ï¼‰
      const minMapForSummary = {};
      CARD_DATA.forEach(card => {
        card.number_of_payments.forEach((n, i) => {
          const ar = card.annual_rate[i];
          if (!minMapForSummary[n] || minMapForSummary[n].annual_rate > ar) {
            minMapForSummary[n] = { annual_rate: ar, addonRate: calAddonRate(ar, n) };
          }
        });
      });
      buildSummaryTable(content, selectedInsts, (p, n) => {
        if (n === 1) return p.price;
        const info = minMapForSummary[n];
        if (!info) return null;
        return calcCardMain(p.price, n, info.addonRate).split_fee_cost_per_month;
      });
      simulateMinCard(content, selectedInsts);
    } else {
      const card = CARD_DATA.find(c => c.id === selectedCardId);
      document.getElementById('resultsTitle').textContent = `ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ â€” ${card.name}`;
      // ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ï¼‰
      buildSummaryTable(content, selectedInsts, (p, n) => {
        if (n === 1) return p.price;
        const idx2 = card.number_of_payments.indexOf(n);
        if (idx2 === -1) return null;
        const addonRate = calAddonRate(card.annual_rate[idx2], n);
        return calcCardMain(p.price, n, addonRate).split_fee_cost_per_month;
      });
      simulateSingleCard(content, selectedInsts, card);
    }
  }

  wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function simulateSingleCard(content, selectedInsts, card) {
  products.forEach((p, idx) => {
    const block = document.createElement('div');
    block.className = 'product-result';
    block.style.animationDelay = (idx * 0.08) + 's';

    let rows = '';
    selectedInsts.forEach(n => {
      const isLump = n === 1;
      if (isLump) {
        rows += `<tr class="lump">
          <td>ä¸€æ‹¬æ‰•ã„</td>
          <td class="monthly-pay">${commaFormat(p.price)}</td>
          <td><span class="zero-fee">Â¥0</span></td>
          <td class="total-pay">${commaFormat(p.price)}</td>
          <td><span class="zero-fee">â€”</span></td>
        </tr>`;
        return;
      }
      const idx2 = card.number_of_payments.indexOf(n);
      if (idx2 === -1) {
        rows += `<tr><td>${n}å›æ‰•ã„</td><td colspan="4" style="text-align:center;color:var(--text-dim);font-family:'Noto Sans JP'">ã“ã®ã‚«ãƒ¼ãƒ‰ã§ã¯åˆ©ç”¨ä¸å¯</td></tr>`;
        return;
      }
      const annualRate = card.annual_rate[idx2];
      const addonRate = calAddonRate(annualRate, n);
      const d = calcCardMain(p.price, n, addonRate);
      rows += `<tr>
        <td>${n}å›æ‰•ã„</td>
        <td class="monthly-pay">${commaFormat(d.split_fee_cost_per_month)}</td>
        <td class="fee-pay">${commaFormat(d.split_fee)}</td>
        <td class="total-pay">${commaFormat(d.split_fee_cost)}</td>
        <td style="color:var(--text-dim)">${annualRate}%</td>
      </tr>`;
    });

    block.innerHTML = `
      <div class="product-result-header">
        <span class="product-result-name">${p.name}</span>
        <span class="product-result-price">${commaFormat(p.price)}</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>æ”¯æ‰•ã„å›æ•°</th>
              <th>æœˆã€…ã®æ”¯æ‰•ã„</th>
              <th>æ‰‹æ•°æ–™</th>
              <th>æ”¯æ‰•ç·é¡</th>
              <th>å®Ÿè³ªå¹´ç‡</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
    content.appendChild(block);
  });
}

function simulateMinCard(content, selectedInsts) {
  document.getElementById('resultsTitle').textContent = 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ â€” æ”¯æ‰•å›æ•°æ¯ã®æœ€å®‰å€¤';

  // å„æ”¯æ‰•å›æ•°ã§æœ€å®‰å€¤ã®ã‚«ãƒ¼ãƒ‰ã‚’æ±‚ã‚ã‚‹
  const minMap = {};
  CARD_DATA.forEach(card => {
    card.number_of_payments.forEach((n, i) => {
      const ar = card.annual_rate[i];
      if (!minMap[n] || minMap[n].annual_rate > ar) {
        minMap[n] = { name: card.name, annual_rate: ar, addonRate: calAddonRate(ar, n) };
      }
    });
  });

  products.forEach((p, idx) => {
    const block = document.createElement('div');
    block.className = 'product-result';
    block.style.animationDelay = (idx * 0.08) + 's';

    let rows = '';
    selectedInsts.forEach(n => {
      const isLump = n === 1;
      if (isLump) {
        rows += `<tr class="lump">
          <td>ä¸€æ‹¬æ‰•ã„</td>
          <td><span class="zero-fee">â€”</span></td>
          <td class="monthly-pay">${commaFormat(p.price)}</td>
          <td class="fee-pay"><span class="zero-fee">Â¥0</span></td>
          <td class="total-pay">${commaFormat(p.price)}</td>
          <td><span class="zero-fee">â€”</span></td>
        </tr>`;
        return;
      }
      const info = minMap[n];
      if (!info) {
        rows += `<tr><td>${n}å›æ‰•ã„</td><td colspan="5" style="text-align:center;color:var(--text-dim);font-family:'Noto Sans JP'">å¯¾å¿œã‚«ãƒ¼ãƒ‰ãªã—</td></tr>`;
        return;
      }
      const d = calcCardMain(p.price, n, info.addonRate);
      rows += `<tr>
        <td>${n}å›æ‰•ã„</td>
        <td style="color:var(--accent);font-size:12px">${info.name}<span class="min-badge">æœ€å®‰å€¤</span></td>
        <td class="monthly-pay">${commaFormat(d.split_fee_cost_per_month)}</td>
        <td class="fee-pay">${commaFormat(d.split_fee)}</td>
        <td class="total-pay">${commaFormat(d.split_fee_cost)}</td>
        <td style="color:var(--text-dim)">${info.annual_rate}%</td>
      </tr>`;
    });

    block.innerHTML = `
      <div class="product-result-header">
        <span class="product-result-name">${p.name}</span>
        <span class="product-result-price">${commaFormat(p.price)}</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>æ”¯æ‰•ã„å›æ•°</th>
              <th>ã‚«ãƒ¼ãƒ‰ä¼šç¤¾</th>
              <th>æœˆã€…ã®æ”¯æ‰•ã„</th>
              <th>æ‰‹æ•°æ–™</th>
              <th>æ”¯æ‰•ç·é¡</th>
              <th>å®Ÿè³ªå¹´ç‡</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
    content.appendChild(block);
  });
}

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
function commaFormat(value) {
  return 'Â¥' + parseInt(value).toLocaleString('ja-JP');
}

function showAlert(id, msg, show = true) {
  const el = document.getElementById(id);
  if (show) { el.textContent = msg; el.style.display = 'block'; }
  else { el.style.display = 'none'; }
}

function hideAlert(id) { showAlert(id, '', false); }

function resetAll() {
  products = [];
  document.getElementById('csvInput').value = '';
  document.getElementById('fileName').style.display = 'none';
  document.getElementById('productPreview').classList.add('hidden');
  document.getElementById('resultsWrap').classList.add('hidden');
  document.getElementById('resultsContent').innerHTML = '';
  hideAlert('csvAlert');
}

init();
</script>
</body>
</html>
