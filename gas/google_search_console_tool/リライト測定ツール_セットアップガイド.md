# リライト効果測定ツール - 完全セットアップガイド

## 目次
1. [ツール概要](#ツール概要)
2. [事前準備](#事前準備)
3. [セットアップ手順](#セットアップ手順)
4. [使い方](#使い方)
5. [プログラムフロー](#プログラムフロー)
6. [トラブルシューティング](#トラブルシューティング)

---

## ツール概要

### 機能
- リライト前後のSearch Consoleデータを自動取得・比較
- 記事単位でのクリック数、表示回数、CTR、平均掲載順位を測定
- キーワード別の詳細分析（重要度の自動判定付き）
- 変化率の自動計算と改善/悪化の判定

### 出力内容
1. **サマリーシート**: 全体的な数値比較
2. **キーワード別シート**: キーワードごとの詳細データ

---

## 事前準備

### 必要なもの
1. Googleアカウント
2. Google Search Consoleへのアクセス権限
3. 測定したい記事のURL
4. リライト実施日

### 確認事項
- Search ConsoleプロパティURL: `https://life-simulation.dream-target.jp/`
- 測定対象記事: 例 `https://life-simulation.dream-target.jp/mirable-12`

---

## セットアップ手順

### ステップ1: Googleスプレッドシート作成

1. Googleスプレッドシートを新規作成
2. 任意の名前を付ける（例: 「リライト効果測定」）

---

### ステップ2: Apps Scriptエディタを開く

1. スプレッドシートのメニューから「**拡張機能**」→「**Apps Script**」をクリック
2. 新しいタブでApps Scriptエディタが開く

---

### ステップ3: コードを貼り付け

1. デフォルトで表示されている `function myFunction() {}` を**全て削除**
2. 以下のコードを貼り付け

```javascript
// ========================================
// リライト効果測定ツール - Google Apps Script
// ========================================

// 設定項目
const CONFIG = {
  siteUrl: 'https://life-simulation.dream-target.jp/',
  targetUrl: 'https://life-simulation.dream-target.jp/mirable-12',
  rewriteDate: '2024-12-05', // リライト日
  beforeDays: 30,  // リライト前の測定期間
  afterDays: 30    // リライト後の測定期間
};

// [以降のコードは実際のスクリプトファイルから取得]
```

3. **💾保存**アイコンをクリック

---

### ステップ4: Google Cloud Projectの設定

#### 4-1. プロジェクトの設定

1. Apps Scriptエディタの左側で「**プロジェクトの設定**」（歯車アイコン）をクリック
2. 下にスクロールして「**Google Cloud Platform（GCP）プロジェクト**」セクションを探す
3. 「**プロジェクトを変更**」をクリック
4. GCPプロジェクト番号を入力: `867042146847`
5. 「**プロジェクトを設定**」をクリック

#### 4-2. OAuth同意画面の設定

以下のURLにアクセス:
https://console.cloud.google.com/apis/credentials/consent?project=optimal-vial-264610

1. **User Type**: 「外部」を選択 → 「作成」

2. **アプリ情報** を入力:
   - アプリ名: `リライト測定ツール`
   - ユーザーサポートメール: 自分のGmailアドレスを選択
   - デベロッパーの連絡先情報: 自分のGmailアドレスを入力
   - 「**保存して次へ**」

3. **スコープ**: そのまま「**保存して次へ**」

4. **テストユーザー**:
   - 「**+ ADD USERS**」をクリック
   - 自分のGmailアドレスを追加
   - 「**保存して次へ**」

5. **概要**: 「**ダッシュボードに戻る**」

#### 4-3. Search Console APIの有効化

以下のURLにアクセス:
https://console.cloud.google.com/apis/library/searchconsole.googleapis.com?project=optimal-vial-264610

1. 「**有効にする**」ボタンをクリック
2. 有効化完了まで数秒待つ

---

### ステップ5: appsscript.json の設定

1. Apps Scriptエディタに戻る
2. 左側の「**プロジェクトの設定**」（歯車アイコン）をクリック
3. 「**appsscript.json マニフェストファイルをエディタで表示する**」をONにする
4. 左側のファイル一覧に「**appsscript.json**」が表示されるのでクリック
5. 以下の内容に置き換え:

```json
{
  "timeZone": "Asia/Tokyo",
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8",
  "oauthScopes": [
    "https://www.googleapis.com/auth/webmasters.readonly",
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/script.external_request"
  ]
}
```

6. **💾保存**

---

### ステップ6: 権限の承認

1. Apps Scriptエディタ上部で関数を「**runRewriteAnalysis**」に選択
2. **▶実行**ボタンをクリック
3. 権限の確認ダイアログが表示される:
   - 「**権限を確認**」をクリック
   - Googleアカウントを選択
   - 「**詳細**」をクリック
   - 「**〜（安全ではないページ）に移動**」をクリック
   - 「**許可**」をクリック

---

### ステップ7: 動作確認

1. スプレッドシートに戻る
2. ページを更新すると、メニューに「**リライト測定**」が追加されている
3. 「**リライト測定**」→「**分析実行**」をクリック
4. 「分析完了！」のメッセージが表示されればOK

---

## 使い方

### 基本的な使い方

1. **測定対象を変更する場合**
   - Apps Scriptエディタでコードの冒頭部分（CONFIG）を編集
   ```javascript
   const CONFIG = {
     siteUrl: 'https://life-simulation.dream-target.jp/',
     targetUrl: 'https://life-simulation.dream-target.jp/【記事URL】', // ←変更
     rewriteDate: '2024-12-05', // ←変更
     beforeDays: 30,
     afterDays: 30
   };
   ```

2. **分析を実行**
   - スプレッドシートのメニュー「**リライト測定**」→「**分析実行**」

3. **結果を確認**
   - 「**サマリー**」シート: 全体の数値比較
   - 「**キーワード別**」シート: キーワードごとの詳細

---

### データの見方

#### サマリーシート
| 指標 | リライト前 | リライト後 | 変化 | 変化率 | 判定 |
|------|-----------|-----------|------|--------|------|
| クリック数 | 50 | 65 | +15 | +30.0% | 改善 ✓ |
| 表示回数 | 1000 | 1200 | +200 | +20.0% | 改善 ✓ |
| CTR (%) | 5.0 | 5.4 | +0.4 | +8.0% | 改善 ✓ |
| 平均掲載順位 | 15.2 | 12.8 | -2.4 | -15.8% | 改善 ✓ |

#### キーワード別シート
- **重要度の自動判定**
  - ★★★ メイン: クリック数10以上
  - ★★ 準メイン: クリック数3以上
  - ★ サブ: クリック数1以上
  - - その他: クリック数0

---

## プログラムフロー

### 全体フロー

```
┌─────────────────────────┐
│ 1. ユーザーが「分析実行」 │
│    メニューをクリック      │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ 2. シート準備             │
│  - サマリーシート作成     │
│  - キーワード別シート作成 │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ 3. 期間計算               │
│  - リライト前期間算出     │
│  - リライト後期間算出     │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ 4. APIデータ取得（前）    │
│  - Search Console API呼出 │
│  - キーワード別データ取得 │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ 5. APIデータ取得（後）    │
│  - Search Console API呼出 │
│  - キーワード別データ取得 │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ 6. データ集計・比較       │
│  - サマリー計算           │
│  - 変化率計算             │
│  - 判定（改善/悪化）      │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ 7. スプレッドシート出力   │
│  - サマリーシートに書込み │
│  - キーワード別シートに   │
│    書込み                 │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ 8. 完了メッセージ表示     │
└─────────────────────────┘
```

### 詳細フロー: データ取得部分

```
┌──────────────────────┐
│ getSearchConsoleData │
│ 関数開始              │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ リクエストボディ作成  │
│  - 期間指定          │
│  - ディメンション設定│
│  - フィルタ設定      │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ API URL構築          │
│  - サイトURLエンコード│
│  - エンドポイント組立│
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ UrlFetchApp.fetch    │
│  - REST API呼出      │
│  - OAuth認証         │
└──────┬───────────────┘
       │
       ▼
    ┌──┴──┐
    │ 成功? │
    └──┬──┘
   Yes │ No
       │  └──────────┐
       ▼             ▼
┌──────────────┐ ┌─────────┐
│ JSONパース   │ │ エラー  │
└──────┬───────┘ │ スロー  │
       │         └─────────┘
       ▼
┌──────────────────────┐
│ データ整形            │
│  - サマリー集計       │
│  - キーワード配列作成 │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ 結果を返す            │
│  {summary, keywords} │
└──────────────────────┘
```

### 詳細フロー: サマリー書き込み

```
┌────────────────────┐
│ writeSummarySheet  │
│ 関数開始            │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│ ヘッダー情報書き込み│
│  - 測定URL         │
│  - リライト日      │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│ テーブルヘッダー    │
│ 書き込み            │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│ 各指標をループ処理  │
│  - クリック数      │
│  - 表示回数        │
│  - CTR            │
│  - 平均掲載順位    │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│ 各行で以下を計算    │
│  - 変化量          │
│  - 変化率          │
│  - 判定            │
└────────┬───────────┘
         │
         ▼
┌────────────────────┐
│ 書式設定            │
│  - 列幅調整        │
│  - 色付け          │
└────────────────────┘
```

### 詳細フロー: キーワード書き込み

```
┌──────────────────────┐
│ writeKeywordSheet    │
│ 関数開始              │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ ヘッダー書き込み      │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ キーワードマージ      │
│  - リライト前データ  │
│  - リライト後データ  │
│  を統合              │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ 各キーワードをループ  │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ 重要度判定            │
│  ★★★ クリック10+   │
│  ★★  クリック3+    │
│  ★   クリック1+    │
│  -    その他         │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ データ行作成          │
│  - 前後比較データ    │
│  - 変化量計算        │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ クリック数でソート    │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ スプレッドシート書込み│
│ 書式設定              │
│  - 列幅調整          │
│  - 重要度で色付け    │
└──────────────────────┘
```

---

## トラブルシューティング

### よくあるエラーと解決方法

#### 1. `SearchConsole is not defined`
**原因**: Search Console APIがサービスとして追加されていない

**解決方法**:
- Google Cloud ConsoleでSearch Console APIを有効化
- GCPプロジェクトをApps Scriptに紐付け

---

#### 2. `HTTP 403: Permission Denied`
**原因**: APIが有効化されていない、または権限不足

**解決方法**:
- https://console.cloud.google.com/apis/library/searchconsole.googleapis.com?project=optimal-vial-264610 でAPIを有効化
- OAuth同意画面の設定を完了
- テストユーザーに自分を追加

---

#### 3. `HTTP 404: Not Found`
**原因**: API URLが間違っている

**解決方法**:
- エンドポイントが `https://www.googleapis.com/webmasters/v3/...` になっているか確認
- サイトURLのエンコード方法を確認

---

#### 4. `外部リクエスト権限不足`
**原因**: `appsscript.json` に必要なスコープが不足

**解決方法**:
- `appsscript.json` に以下を追加:
```json
"oauthScopes": [
  "https://www.googleapis.com/auth/webmasters.readonly",
  "https://www.googleapis.com/auth/spreadsheets",
  "https://www.googleapis.com/auth/script.external_request"
]
```

---

#### 5. データが0件
**可能性**:
1. 測定URLが間違っている
2. 期間内にデータがない
3. Search Consoleにデータが反映されていない

**確認方法**:
- Search Console管理画面で手動確認
- URLを完全一致で指定（末尾のスラッシュも含む）
- リライト後は数日待つ必要がある場合も

---

## 設定ファイル（CONFIG）詳細

```javascript
const CONFIG = {
  // Search ConsoleのプロパティURL
  siteUrl: 'https://life-simulation.dream-target.jp/',
  
  // 測定対象記事の完全URL
  targetUrl: 'https://life-simulation.dream-target.jp/mirable-12',
  
  // リライトを実施した日（YYYY-MM-DD形式）
  rewriteDate: '2024-12-05',
  
  // リライト前の測定期間（日数）
  beforeDays: 30,
  
  // リライト後の測定期間（日数）
  afterDays: 30
};
```

### 変更時の注意点
- `siteUrl`: 末尾のスラッシュ `/` を含める
- `targetUrl`: Search Consoleに表示される完全一致のURL
- `rewriteDate`: YYYY-MM-DD形式で指定
- `beforeDays`, `afterDays`: 最大値は Google Search Console APIの制限（16ヶ月）

---

## まとめ

このツールにより、以下が自動化されます:

✅ **リライト前後のデータ取得**
✅ **数値の比較・変化率計算**
✅ **キーワード別の詳細分析**
✅ **重要度の自動判定**
✅ **改善/悪化の自動判定**

### 今後の活用方法
1. 定期的に複数記事を測定
2. 成功パターンの分析
3. キーワード戦略の改善
4. リライト効果のレポート作成

---

**作成日**: 2024年12月7日
**バージョン**: 1.0
